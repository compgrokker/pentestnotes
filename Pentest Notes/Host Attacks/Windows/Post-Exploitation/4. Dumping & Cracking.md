migrate meterpreter to lsass
`migrate -N lsass.exe`
`hashdump`
background meterpreter and check the creds got saved with `creds`
`use auxiliary/analyze/crack_windows`

  
## Snaffler

snaffler will search AD for creds (and other stuff)

https://github.com/SnaffCon/Snaffler

### What is it for?

  [](https://github.com/SnaffCon/Snaffler#what-is-it-for)

Snaffler is a tool for **pentesters** and **red teamers** to help find delicious candy needles (creds mostly, but it's flexible) in a bunch of horrible boring haystacks (a massive Windows/AD environment).
 
It might also be useful for other people doing other stuff, but it is explicitly NOT meant to be an "audit" tool.
 
### I don't want to read all this!!!
 [](https://github.com/SnaffCon/Snaffler#i-dont-want-to-read-all-this)
 Ugh, fine. But we aren't responsible for the results. We wrote all this other stuff for you, but that's okay. We're not mad, just disappointed.
 `snaffler.exe -s -o snaffler.log`
### What does it do?
 [](https://github.com/SnaffCon/Snaffler#what-does-it-do)
_Broadly speaking_ - it gets a list of Windows computers from Active Directory, then spreads out its snaffly appendages to them all to figure out which ones have file shares, and whether you can read them.

 Then YET MORE snaffly appendages enumerate all the files in those shares and use **L**EARNED **A**RTIFACTUAL **I**NTELLIGENCE for **M**ACHINES to figure out which ones a grubby little hacker like you might want.

Actually it doesn't do any ML stuff, because doing that right would require training data, and that would require an enormous amount of time that we don't have. Instead, like all good "ML" projects, it just uses a shitload of `if` statements and regexen.

  

## Manspider

[![Man-Spider](https://static.wikia.nocookie.net/villains/images/8/8f/Man-Spider.png/revision/latest/scale-to-width-down/350?cb=20140729015041)

  

](https://static.wikia.nocookie.net/villains/images/8/8f/Man-Spider.png/revision/latest?cb=20140729015041 "Man-Spider")

manspider to crawl SMB shares with a provided username

https://github.com/blacklanternsecurity/MANSPIDER

### Crawl SMB shares for juicy information. File content searching + regex is supported!
 
[](https://github.com/blacklanternsecurity/MANSPIDER#crawl-smb-shares-for-juicy-information-file-content-searching--regex-is-supported)
### UPDATE 2023-10-15
[](https://github.com/blacklanternsecurity/MANSPIDER#update-2023-10-15)

  **[textract](https://github.com/deanmalmgren/textract), one of manspider's upstream dependencies, is no longer being updated. For this reason, you may run into problems when installing with pip. The recommended installation method is now [Docker](https://hub.docker.com/r/blacklanternsecurity/manspider):**

  ```shell

docker run --rm -v ./manspider:/root/.manspider blacklanternsecurity/manspider --help

```

  Note there is also a helper script `manspider.sh` which will automatically mount volumes for manspider's `loot` and `logs` directories, making it a bit more convenient to run:
 
```shell

./manspider.sh --help

```

  [![manspider](https://user-images.githubusercontent.com/20261699/74963251-6a08de80-53df-11ea-88f4-60c39665dfa2.gif)](https://user-images.githubusercontent.com/20261699/74963251-6a08de80-53df-11ea-88f4-60c39665dfa2.gif)

### File types supported:
 [](https://github.com/blacklanternsecurity/MANSPIDER#file-types-supported)
- `PDF`
- `DOCX`
- `XLSX`
- `PPTX`
- any text-based format
- and many more!!
### MANSPIDER will crawl every share on every target system. If provided creds don't work, it will fall back to "guest", then to a null session.


### NTLM Cracking

NTLM is only for local Windows accounts, not  AD.

Windows stores hashed user passwords in the _Security Account Manager_ (SAM)[1](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-1) database file, which is used to authenticate local or remote users.

To deter offline SAM database password attacks, Microsoft introduced the _SYSKEY_ feature in Windows NT 4.0 SP3, which partially encrypts the SAM file. The passwords can be stored in two different hash formats: _LAN Manager_ (LM)[2](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-2) and NTLM. LM is based on _DES_,[3](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-3) and is known to be very weak. For example, passwords are case insensitive and cannot exceed fourteen characters. If a password exceeds seven characters, it is split into two strings, each hashed separately. LM is disabled by default beginning with Windows Vista and Windows Server 2008.

NTLM hashes are now used.  case-sensitive, no longer split.  But still not salted.  Lack of salt opens up NTLM to rainbow table attack.

We cannot just copy, rename, or move the SAM database from `C:\Windows\system32\config\sam` while the Windows operating system is running because the kernel keeps an exclusive file system lock on the file.

Mimikatz also includes the _sekurlsa_ module, which extracts password hashes from the _Local Security Authority Subsystem_ (LSASS)[8](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-8) process memory. LSASS is a process in Windows that handles user authentication, password changes, and _access token_[9](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-9) creation.

LSASS runs under the SYSTEM user and is therefore even more privileged than a process started as Administrator.

Due to this, we can only extract passwords if we are running Mimikatz as Administrator (or higher) and have the _SeDebugPrivilege_[10](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-10) access right enabled. This access right grants us the ability to debug not only processes we own, but also all other users' processes.

We can also elevate our privileges to the _SYSTEM_ account with tools like _PsExec_[11](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-11) or the built-in Mimikatz _token elevation function_[12](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-12) to obtain the required privileges. The token elevation function requires the _SeImpersonatePrivilege_[13](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/cracking-ntlm-44965#fn-local_id_46-13) access right to work, but all local administrators have it by default.

[[Finding Credentials]]

hashcat mode 1000
`hashcat -m 1000 <ntlm hash file> /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force`
### NTLM Passing

Pass the Hash
use a valid combo of username and NTLM hash rather than plaintext password.  password hashes aren't salted and remain static between sessions, including being valid for the same account on a different system.

must be Administrator to execute code
tool must support auth via hash
* smb enumeration and management
	* smbclient
	* CrackMapExec
* command execution
	* impacket
	* psexec.py
	* wmiexec.py
we can also access the system via SMB, RDP, and WinRM with proper rights.

`smbclient \\\\192.168.50.212\\secrets -U Administrator --pw-nt-hash 7a38310ea6f0027ee955abed1762964b`

We can use the _impacket-scripts_[9](https://portal.offsec.com/courses/pen-200-44065/learning/password-attacks-44959/working-with-password-hashes-45019/passing-ntlm-44966#fn-local_id_50-9) package to execute **psexec.py** on Kali. This package contains links to the example scripts of the impacket library and provides a user-friendly way to use them.

To execute _psexec_, we can enter **impacket-psexec** with two arguments. The first argument is **-hashes**, which allows us to use NTLM hashes to authenticate to the target. The format is "LMHash:NTHash", in which we specify the Administrator NTLM hash after the colon. Since we only use the NTLM hash, we can fill the LMHash section with 32 0's.

The second argument is the target definition in the format "username@ip".
`impacket-psexec -hashes 00000000000000000000000000000000:7a38310ea6f0027ee955abed1762964b Administrator@192.168.50.212`
**psexec.py will always give us a SYSTEM shell instead of the user authenticated as**
wmiexec.py will give a shell as the authenticated user
### Net-NTLMv2 Cracking


### Net-NTLMv2 Relaying