## On-Disk Evasion
Used to obfuscate files on physical disk

1. Packers.  Earliest way of avoiding detection.  Designed to reduce size, would unpack into 'new' binary, bypassing signature-based detection.  Some modern malware uses a variation of this, but packing alone is insufficient to evade modern AV.
2. Obfuscators. Re-org and mutate code, making it difficult to reverse-engineer.  Replace instructions with semantically equivalent ones, insert dead code, split/reorder functions, etc.  Marginally effective  against signature-based AV.  Modern obfuscators also have runtime in-memory capabilities which hinder detection further
3. Crypter. Cryptographically alters executable code, adding decrypt stub to restore code upon execution.  Decryption happens in-memory, only encrypted code is saved on disk.  Very effective modern technique.
4. Highly effective antivirus evasion requires a combination of all of the previous techniques in addition to other advanced ones, including _anti-reversing_, _anti-debugging_, _virtual machine emulation detection_, and so on. In most cases, _software protectors_ were designed for legitimate purposes, like _anti-copy_, but can also be used to bypass AV detection.

## In-Memory Evasion
1. In-memory injections, aka PE injection. Bypass AV on Windows.  Manipulate volatile memory.  Does not write files to disk.
2. Remote Process Memory Injection. Inject payload into another valid PE that's not malicious.  Most common process leveraging Windows APIs:
	1. use the _OpenProcess_[4](https://portal.offsec.com/courses/pen-200-44065/learning/antivirus-evasion-44896/bypassing-antivirus-detections-44921/on-disk-evasion-44901#fn-local_id_28-4) function to obtain a valid _HANDLE_[5](https://portal.offsec.com/courses/pen-200-44065/learning/antivirus-evasion-44896/bypassing-antivirus-detections-44921/on-disk-evasion-44901#fn-local_id_28-5) to a target process that we have permission to access.
	2. After obtaining the HANDLE, we would allocate memory in the context of that process by calling a Windows API such as _VirtualAllocEx_.[6](https://portal.offsec.com/courses/pen-200-44065/learning/antivirus-evasion-44896/bypassing-antivirus-detections-44921/on-disk-evasion-44901#fn-local_id_28-6)
	3.  Once the memory has been allocated in the remote process, we would copy the malicious payload to the newly allocated memory using _WriteProcessMemory_.[7](https://portal.offsec.com/courses/pen-200-44065/learning/antivirus-evasion-44896/bypassing-antivirus-detections-44921/on-disk-evasion-44901#fn-local_id_28-7)
	4.  After the payload has been successfully copied, it is usually executed in memory in a separate thread using the _CreateRemoteThread_[8](https://portal.offsec.com/courses/pen-200-44065/learning/antivirus-evasion-44896/bypassing-antivirus-detections-44921/on-disk-evasion-44901#fn-local_id_28-8) API.
3. Process hollowing. 
4. Inline hooking.
There are other techniques, but they require low level programming language skills and are beyond the scope of PEN-200/OSCP.

## AV Evasion in Practice
Test payloads with antiscan.me rather than VirusTotal to keep them from being loaded into AV signature lists.

[[In-Memory Injection Powershell]] 

[[Obfuscation]]

